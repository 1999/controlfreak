<html>
<head>
<script src="jquery-1.4.2.min.js"></script>
<script src="jquery.url.js"></script>
<script src="underscore-min.js"></script>
<script src="scriptDAO.js"></script>
<script src="url.js"></script>
<script src="util.js"></script>
<script src="codemirror/codemirror.js"></script>
<style>
  /* see http://code.google.com/p/chromium/issues/detail?id=26152 */
  html { width: 300px; height: 300px;}
  body { overflow: hidden; border: 0px; width: 300px; height: 300px; margin: 0px 0px 10px;}
  div#wrapper {height: 100%; width: 100%; border-radius: 6px; border: 1px solid #DDD; background-color: #EEE; margin: 0; padding: 0; overflow:hidden;}
  body iframe{ border: 0px;}
  a,a:visited { color: #00b; }
  textarea { width: 97.5%; }
  .debug { display: none; }
  #scopeZone { margin-bottom: 7px;height: 50px; margin-top: 7px; }
  #scopeDisplay { float: left; line-height: 1em;text-overflow:ellipsis; height: 14px;margin-bottom: 3px; padding: 5px; font-size: 12px; width:96.75%; white-space: nowrap; overflow:hidden;}
  #scopeDisplay { background: #FFF;}
  .scopeLevels { list-style: none; clear: left; margin: 0px; width: 100%; height: 24px; margin-top: 2px; padding: 0px; background-color: #DDD;}
  .scopeLevel { float: left; 
    position: relative; 
    display: block; 
    cursor: pointer; 
    color: #222; 
    padding: 3px 10px 2px 16px; 
    background-color: #DDD;
    margin: 0px 0px 0px 0px;}
  .scopeLevel:first-child{
    padding-left: 6px;
  }
  .scopeLevel:after{content: " "; 
    width: 0; height: 0; 
    display: block; 
    position: absolute; 
    right: -11px; 
    top: 0; 
    border-top: 11px solid transparent; 
    border-bottom: 11px solid transparent; 
    border-left: 11px solid #DDD;
    z-index: 100;}
  .scopeLevel:hover{ color: #111; background-color: #BBB;}
  .scopeLevel:hover:after{
    border-left: 11px solid #BBB!important;
  }
  .active { background: #68E; text-decoration: none; color: #FFF; }
  .scopeLevel.active:after{
    border-left: 11px solid #68E;
  }
  .scopeLevel:nth-child(n+2):before{
    content: " "; display: block; position: absolute; left: 1px; top: 0;
    border-top: 11px solid transparent;
    border-bottom: 11px solid transparent;
    border-left: 11px solid #EEE;
    width: 0; height: 0;
    z-index: 50;
  }
  .undefined { font-style: italic; }
  .defined { font-style: normal; }
  #scriptTypes {float:left; clear:both; width: 94%; padding-left: 13px;}
  #scriptTypes a { float: right; margin-right: 3%;}
  .scriptType { background: #bbb; padding: 2px 4px; border-bottom-color: white; z-index: 100; margin-right: 5px; cursor: pointer; border: 1px solid #666; display: inline; position: relative; opacity: 0.5; top: 0; }
  .scriptType.active { background: white; cursor: default; opacity: 1; background: #68E; color: #FFF; padding: 2px 4px;}
  .active .openBorder { background: #68E; z-index: 400; color: #FFF; }
  .openBorder { position: absolute; bottom: -1; height: 1px; width: 100%; background: #666; z-index: 200; border-left: 1px solid #666; border-right: 1px solid #666; }
  textarea, textarea:focus {outline: 0;}
  .CodeMirror-wrapping{border: 1px solid #CCC; background: #FFF; width: 96%;margin: 27px 2% 0px 2%; border-radius: 6px;}
</style>
<script>
if (!localStorage["scopeLevel"]) localStorage["scopeLevel"] = "all";
if (!localStorage["scriptType"]) localStorage["scriptType"] = "js";

$(function() {
  $(".scriptType").each(function() {
    $("<div class='openBorder' />").appendTo(this);
  });
  $(".scopeLevel").click(function() {
    updateScopeLevel($(this).attr("id"));
  });
  $(".scriptType").click(function() {
    updateScriptType($(this).attr("id"));
  });
});

function onPageChange(page) {
  updateScopeLevel(localStorage["scopeLevel"]);
  updateScriptType(localStorage["scriptType"]);
}
function updateScopeLevel(scopeLevel) {
  localStorage["scopeLevel"] = scopeLevel;
  repaint();
}
function updateScriptType(scriptType) {
  localStorage["scriptType"] = scriptType;
  repaint();
}

function repaint() {
  $(".active").removeClass("active");

  var scopeLevel=localStorage["scopeLevel"], scriptType=localStorage["scriptType"];
  
  $("#scopeDisplay").html(scopeLevel=="all" ? "all sites" : (scopeLevel=="host" ? currentPage.getHost() : currentPage.getURL()));
  $(".scopeLevel[id="+scopeLevel+"]").addClass("active");
  $(".scriptType[id="+scriptType+"]").addClass("active");
  
  getEditor().setCode(scriptDAO.load(localStorage["scriptType"], getScope())||"");

  $(".scopeLevel").each(function(i, aScopeLevel) {
    $(this).classIf(scriptDAO.defined(scriptType, getScope(aScopeLevel.id)),
      "defined", "undefined");
  });

  $(".scriptType").each(function(i, aScriptType) {
    $(this).classIf(scriptDAO.defined(aScriptType.id, getScope(scopeLevel)),
      "defined", "undefined");
  });
  
  //force a re-highlight of the new loaded code.
  getEditor().editor.highlightDirty();
}

function save() {
  scriptDAO.save(getEditor().getCode(), localStorage["scriptType"], getScope());
  repaint();
}
function getScope(scopeLevel) {
  var scopeLevel = scopeLevel || localStorage["scopeLevel"];
  return scopeLevel=="all" ? "*" : (scopeLevel=="host" ? currentPage.getHost() : currentPage.getURL());
}
function log(m) {
  console.log(m);
}

/**
 * Private variable for the editor
 * @private
 */
var editor_ = null;

/**
 * function accessor for the codemirror editor. gets created on the fly, and maintain's it's
 * singltonnyness.
 * @return {Object} A Codemirror Editor that is bound to the #code textarea.
 */
function getEditor(){
    if(editor_ === null){
        editor_ = CodeMirror.fromTextArea('code', {
            height: '190px',
            parserfile: ["parsecss.js", "tokenizejavascript.js", "parsejavascript.js"],
            stylesheet: ['css/jscolors.css', 'css/csscolors.css'],
            path: 'codemirror/', //location of the extra js source
            saveFunction: save, //map cmd+s to the save button's function
            autoMatchParens: true //auto insert parens where needed
        });
        return editor_;
    } else{
        return editor_;
    }
}

</script>
</head>
<body>
<div id="wrapper">
  <a target="x" class="debug" href="chrome-extension://flbbllfioochfjaefcnhjiddnjnbkbno/popup.html">debug</a>
  <div id="scopeZone" class="zone">
    <ul class="scopeLevels">
      <li id="all" class="scopeLevel">All</li>
      <li id="host" class="scopeLevel">This&nbsp;Domain</li>
      <li id="url" class="scopeLevel">This&nbsp;Page</li>
    </ul>
    <div id="scopeDisplay"></div>
  </div>
  
  <div id="scriptTypes" class="zone">
    <span id="js" class="scriptType active">Javascript</span>
    <span id="css" class="scriptType">CSS</span>
    <a target="options" href="options.html">manage&nbsp;all</a>
  </div>
  <textarea id="code"></textarea>
  <button onclick="save(); return false;">Save</button>
</div> 
</body>
</html>
